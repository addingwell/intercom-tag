___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "categories": ["CHAT", "SOCIAL"],
  "displayName": "Intercom",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Addingwell",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Non official tag to create/update user or company. You can also send data event attached to a user.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "accessToken",
    "displayName": "Access Token",
    "simpleValueType": true
  },
  {
    "type": "RADIO",
    "name": "actionType",
    "displayName": "Action",
    "radioItems": [
      {
        "value": "upsert_company",
        "displayValue": "Create or update Company"
      },
      {
        "value": "upsert_user",
        "displayValue": "Create or update User"
      },
      {
        "value": "submit_event",
        "displayValue": "Submit data event"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "upsertCompanyGroup",
    "displayName": "Company Fields",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "companyId",
        "displayName": "Company Id",
        "simpleValueType": true,
        "help": "The company id you have defined for the company"
      },
      {
        "type": "TEXT",
        "name": "companyName",
        "displayName": "Name",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "companyRemoteCreatedAt",
        "displayName": "Remote Created At",
        "simpleValueType": true,
        "help": "The time the company was created by you"
      },
      {
        "type": "TEXT",
        "name": "companyMonthlySpend",
        "displayName": "Monthly Spend",
        "simpleValueType": true,
        "help": "How much revenue the company generates for your business. Note that this will truncate floats. i.e. it only allow for whole integers, 155.98 will be truncated to 155. Note that this has an upper limit of 2**31-1 or 2147483647."
      },
      {
        "type": "TEXT",
        "name": "companyPlan",
        "displayName": "Plan",
        "simpleValueType": true,
        "help": "The name of the plan you have associated with the company"
      },
      {
        "type": "TEXT",
        "name": "companySize",
        "displayName": "Size",
        "simpleValueType": true,
        "help": "The number of employees in this company"
      },
      {
        "type": "TEXT",
        "name": "companyWebsite",
        "displayName": "Website",
        "simpleValueType": true,
        "help": "The URL for this company\u0027s website. Please note that the value specified here is not validated. Accepts any string."
      },
      {
        "type": "TEXT",
        "name": "companyIndustry",
        "displayName": "Industry",
        "simpleValueType": true,
        "help": "The industry that this company operates in"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "actionType",
        "paramValue": "upsert_company",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "upsertUserGroup",
    "displayName": "User Fields",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "userId",
        "displayName": "User Id",
        "simpleValueType": true,
        "help": "A unique string identifier for the user. It is required on creation if an email is not supplied."
      },
      {
        "type": "TEXT",
        "name": "userEmail",
        "displayName": "Email",
        "simpleValueType": true,
        "help": "The user\u0027s email address. It is required on creation if a user_id is not supplied."
      },
      {
        "type": "TEXT",
        "name": "userName",
        "displayName": "Name",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "userPhone",
        "displayName": "Phone",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "userSignedUpAt",
        "displayName": "Signed Up At",
        "simpleValueType": true,
        "help": "A UNIX Timestamp (in timestamp) representing the time the user signed up."
      },
      {
        "type": "TEXT",
        "name": "userLastRequestAt",
        "displayName": "Last Request At",
        "simpleValueType": true,
        "help": "A UNIX timestamp (in seconds) representing the date the user last visited your application."
      },
      {
        "type": "TEXT",
        "name": "unsubscribedFromEmails",
        "displayName": "Unsubscribed From Emails",
        "simpleValueType": true,
        "help": "\"True\" or \"false\" value"
      },
      {
        "type": "TEXT",
        "name": "updateLastRequestAt",
        "displayName": "Update Last Request At",
        "simpleValueType": true,
        "help": "A \"true\" or \"false\" value, which if true, instructs Intercom to update the users\u0027 last_request_at value to the current API service time in UTC. default value if not sent is false."
      },
      {
        "type": "TEXT",
        "name": "newSession",
        "displayName": "New Session",
        "simpleValueType": true,
        "help": "A \"true\" or \"false\" value, which if true, instructs Intercom to register the request as a session."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "actionType",
        "paramValue": "upsert_user",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "submitEventGroup",
    "displayName": "Submit Event Fields",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "seEventName",
        "displayName": "Event Name",
        "simpleValueType": true,
        "help": "The name of the event that occurred. This is presented to your App\u0027s admins when filtering and creating segments - a good event name is typically a past tense \u0027verb-noun\u0027 combination, to improve readability, for example updated-plan."
      },
      {
        "type": "TEXT",
        "name": "seCreatedAt",
        "displayName": "Created At",
        "simpleValueType": true,
        "help": "The time the event occurred as a UTC Unix timestamp (in seconds)"
      },
      {
        "type": "TEXT",
        "name": "seUserId",
        "displayName": "User ID",
        "simpleValueType": true,
        "help": "Your identifier for the user."
      },
      {
        "type": "TEXT",
        "name": "seEmail",
        "displayName": "Email",
        "simpleValueType": true,
        "help": "An email address for your user. An email should only be used where your application uses email to uniquely identify users."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "actionType",
        "paramValue": "submit_event",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "customAttributesGroup",
    "displayName": "Custom attributes",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "label1",
        "displayName": "This group allows you to send any information you wish as custom attributes."
      },
      {
        "type": "LABEL",
        "name": "label2",
        "displayName": "You can send dates as custom attributes by sending a unix timestamp as a Number. If the name of your custom attribute ends with _at then it\u0027ll automatically treat it as a date, rather than a number."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "customAttributes",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Field",
            "name": "field",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": []
          },
          {
            "defaultValue": "string",
            "displayName": "Type",
            "name": "type",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "text",
                "displayValue": "Text"
              },
              {
                "value": "number",
                "displayValue": "Number"
              },
              {
                "value": "boolean",
                "displayValue": "Boolean"
              }
            ],
            "macrosInSelect": false,
            "valueValidators": []
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "actionType",
        "paramValue": "upsert_company",
        "type": "EQUALS"
      },
      {
        "paramName": "actionType",
        "paramValue": "upsert_user",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "seMetaDataGroup",
    "displayName": "Meta Data",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "seLabel1",
        "displayName": "Metadata can be used to submit an event with extra key value data. Each event can contain up to ten metadata key values."
      },
      {
        "type": "LABEL",
        "name": "seLabel2",
        "displayName": "You can send dates as metadata by sending a unix timestamp as a Number. The key musts ends with the String _date and the value is a Unix timestamp, assumed to be in the UTC timezone."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "seMetaData",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Field",
            "name": "field",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": []
          },
          {
            "defaultValue": "string",
            "displayName": "Type",
            "name": "type",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "text",
                "displayValue": "Text"
              },
              {
                "value": "number",
                "displayValue": "Number"
              },
              {
                "value": "boolean",
                "displayValue": "Boolean"
              }
            ],
            "macrosInSelect": false,
            "valueValidators": []
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "actionType",
        "paramValue": "submit_event",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const sendHttpRequest = require('sendHttpRequest');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const getContainerVersion = require('getContainerVersion');
const containerVersion = getContainerVersion();
const isDebug = containerVersion.debugMode;

function parseType (type, value) {
  switch (type) {
    case 'text':
      return makeString(value);
    case 'number':
      return makeNumber(value);
    case 'boolean':
    case 'bool':
      const lowerCaseValue = value.toLowerCase();
      return lowerCaseValue === "true" || lowerCaseValue === "yes" || lowerCaseValue === "1";
  }

  return value;
}

function addParamsToBody(body, existingFields, data) {
  for (let i = 0; i < existingFields.length; i++) {
    const dataFieldName = existingFields[i][0];
    const intercomFieldName = existingFields[i][1];
    const intercomFieldType = existingFields[i][2];
    
    
    if (data[dataFieldName]) {
      body[intercomFieldName] = parseType(intercomFieldType, data[dataFieldName]);
    }
  }
}

function formatCustomAttributes(customAttributes) {
  const res = {};
  
  if (!customAttributes) {
    return res;
  }
  
  for (let i = 0; i < customAttributes.length; i++) {
    const fieldName = customAttributes[i].field;
    const fieldType = customAttributes[i].type;
    const value = customAttributes[i].value;

    res[fieldName] = parseType(fieldType, value);
  }
  
  return res;
}

let path;
const bodyData = {};

switch (data.actionType) {
  case 'upsert_company':
    path = '/companies';

    if (!data.companyId) {
      if (isDebug) {
        logToConsole('Company Id is required');
      }

      data.gtmOnFailure();
      return;
    }
    
    const companyFields = [
      ['companyId', 'company_id'],
      ['companyName', 'name'],
      ['companyRemoteCreatedAt', 'remote_created_at', 'number'],
      ['companyMonthlySpend', 'monthly_spend', 'number'],
      ['companyPlan', 'plan'],
      ['companySize', 'size', 'number'],
      ['companyWebsite', 'website'],
      ['companyIndustry', 'industry'],
    ];

    addParamsToBody(bodyData, companyFields, data);

    bodyData.custom_attributes = formatCustomAttributes(data.customAttributes);
    
    break;
  case 'upsert_user':
    path = '/users';
    
    const userFields = [
      ['userId', 'user_id'],
      ['userName', 'name'],
      ['userPhone', 'phone'],
      ['userSignedUpAt', 'signed_up_at', 'number'],
      ['userLastRequestAt', 'last_request_at', 'number'],
      ['unsubscribedFromEmails', 'unsubscribed_from_emails', 'boolean'],
      ['updateLastRequestAt', 'update_last_request_at', 'boolean'],
      ['newSession', 'new_session', 'boolean'],
    ];
    
    addParamsToBody(bodyData, userFields, data);
    
    bodyData.custom_attributes = formatCustomAttributes(data.customAttributes);

    break;
  case 'submit_event':
    path = '/events';
    
    const eventFields = [
      ['seEventName', 'event_name'],
      ['seCreatedAt', 'created_at', 'number'],
      ['seUserId', 'user_id'],
      ['seEmail', 'email'],
    ];
    
    addParamsToBody(bodyData, eventFields, data);
    
    bodyData.metadata = formatCustomAttributes(data.seMetaData);

    break;
  default:
    if (isDebug) {
      logToConsole('Invalid Type');
    }

    data.gtmOnFailure();
    return;
}

if (isDebug) {
  logToConsole(path, bodyData);
}

sendHttpRequest('https://api.intercom.io' + path, (statusCode, headers, body) => {
  if (statusCode >= 200 && statusCode < 300) {
    data.gtmOnSuccess();
  } else {
    if (isDebug) {
       
    } 
    data.gtmOnFailure();
  }
}, {
  headers: { 'Authorization': 'Bearer ' + data.accessToken, 'Intercom-Version': '1.4', 'Accept': 'application/json', 'Content-Type': 'application/json' },
  method: 'POST',
  timeout: 3500
}, JSON.stringify(bodyData));


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.intercom.io/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 12/3/2021, 10:58:49 AM

